---
title: ChatAhzkwid
layout: null
search: false
---

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChatAhzkwid</title>
<link rel="icon" href="{{ '/assets/favicon.png' | relative_url }}" type="image/png">
<style>
  body{margin:0;height:100vh;display:flex;font-family:ui-sans-serif,system-ui,'Segoe UI',AppleSDGothicNeo,Pretendard,Arial,sans-serif}
  aside{width:250px;border-right:1px solid #eee;padding:20px;box-sizing:border-box;overflow-y:auto}
  main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;box-sizing:border-box;gap:18px;padding:20px 30px 0;position:relative;text-align:center;}
  main.no-chat{justify-content:center;gap:28px;}
  .logo{max-width:200px;height:auto;margin:10px 0 4px}
  .tagline{font-size:18px;font-weight:600;white-space:pre-line}
  #q{width:100%;max-width:700px;padding:14px 16px;border:1px solid #ddd;border-radius:10px;font-size:16px;box-sizing:border-box}
  #chat-container{width:100%;max-width:900px;flex:1 1 auto;text-align:left;margin:0 auto;overflow-y:auto;border:1px solid #eee;border-radius:14px;padding:22px 24px 30px;background:#f9f9f9;box-sizing:border-box;}
  .chat-message{margin-bottom:15px}
  .chat-message.user{text-align:right}
  .chat-message.bot{text-align:left}
  .message-bubble{display:inline-block;padding:10px 15px;border-radius:18px;max-width:80%;word-break:break-word;white-space:pre-wrap}
  .message-bubble.user{background:#007bff;color:#fff;cursor:pointer}
  .message-bubble.user:hover{filter:brightness(1.06)}
  .message-bubble.bot{background:#fff;border:1px solid #ddd}
  .chat-message.bot strong{cursor:pointer}
  .chat-message.bot strong:hover{text-decoration:underline}
  .search-container{position:sticky;bottom:0;width:100%;max-width:900px;padding:14px 0 20px;background:linear-gradient(to top,#ffffff 80%,rgba(255,255,255,0));box-sizing:border-box;display:flex;flex-direction:column;align-items:center;gap:6px;}
  main.no-chat .search-container{position:static;bottom:auto;background:transparent;padding:0;}
  .input-wrap{position:relative;width:100%;max-width:700px;}
  #suggestions{max-width:700px;width:100%;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 10px 10px;position:absolute;z-index:1000;display:none;max-height:240px;overflow-y:auto;top:100%;text-align:left;left:0;}
  main.chat-active #suggestions{top:auto;bottom:100%;border-radius:10px 10px 0 0;border-top:1px solid #ddd;border-bottom:none;left:0;}
  main.no-chat #suggestions{top:100%;bottom:auto;border-radius:0 0 10px 10px;border-top:none;border-bottom:1px solid #ddd;}
  .suggestion-item{padding:10px 16px;cursor:pointer;border-bottom:1px solid #f0f0f0;background:#fff;text-align:left}
  .suggestion-item:last-child{border-bottom:none}
  .suggestion-item:hover{background:#f6f6f6}
  #results{display:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);border:0}
  main.no-chat #chat-container{display:none;}
  main.chat-active .logo, main.chat-active #tagline{display:none !important;}
  #chat-container::-webkit-scrollbar{width:10px}
  #chat-container::-webkit-scrollbar-track{background:transparent}
  #chat-container::-webkit-scrollbar-thumb{background:#d0d0d0;border-radius:6px}
  #chat-container::-webkit-scrollbar-thumb:hover{background:#b5b5b5}
  .doc-preview{margin-top:8px;border:1px solid #ddd;background:#fff;border-radius:12px;max-height:100%-200px;overflow:hidden;padding:0;position:relative;width:100%;}
  .doc-preview.loading:before{content:'ローディング...';display:block;color:#666;font-size:14px;padding:18px}
  .doc-preview iframe{width:100%;border:0;background:#fff;display:block;min-height:400px}
  .chat-message.bot.latest .message-bubble.bot{max-width:100%;width:100%;display:block;text-align:left}
  .admin-indicator{position:fixed;top:6px;right:10px;font-size:12px;padding:4px 8px;border-radius:12px;background:#222;color:#fff;opacity:.75;z-index:999;font-family:ui-sans-serif,system-ui}
</style>
</head>
<body>
  {% include sidebar.html %}
  <main class="no-chat">
    <img class="logo" src="{{ '/assets/logo.png' | relative_url }}" alt="Ahzkwid DevLog">
    <div id="tagline" class="tagline"></div>
    <div id="chat-container"></div>
    <div class="search-container">
      <label class="sr-only" for="q">Chat Query</label>
      <div class="input-wrap">
        <input id="q" type="search" placeholder="検索" autocomplete="off" autofocus>
        <div id="suggestions"></div>
      </div>
    </div>
    <div id="results"></div>
  </main>
<script src="{{ '/assets/js/docFilter.js' | relative_url }}"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
  const q = document.getElementById('q');
  const chatContainer = document.getElementById('chat-container');
  const suggestionsContainer = document.getElementById('suggestions');
  const taglineEl = document.getElementById('tagline');
  const mainEl = document.querySelector('main');

  // Japanese messages only
  const messages = [
    'ahzkwidに聞いてください',
    'AIではありません。人間です',
    '何でも検索してみてください'
  ];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  taglineEl.textContent = pick(messages);
  q.placeholder = '検索または質問を入力';

  // Admin detection via ?admin=1 (no localStorage side-effects)
  function isAdmin(){
    return /(?:^|[?&])admin=1(?:&|$)/.test(window.location.search);
  }
  if(isAdmin()){\n    const badge=document.createElement('div');\n    badge.className='admin-indicator';\n    badge.textContent='ADMIN';\n    document.body.appendChild(badge);\n  }

  // Regex sets
  const JAPANESE_REGEX = /[ぁ-んァ-ン一-龯々〆ヵヶ]/;
  const KOREAN_REGEX = /[\u1100-\u11FF\u3130-\u318F\uAC00-\uD7AF]/;

  function isJapaneseDoc(text){
    return JAPANESE_REGEX.test(text);
  }
  function hasKorean(text){
    return KOREAN_REGEX.test(text);
  }
  function allowDocForUser(text){
    if(isAdmin()) return true;
    // Exclude if contains Korean
    if(hasKorean(text)) return false;
    // Require at least some Japanese characters
    return isJapaneseDoc(text);
  }
  function filterDocs(list){
    return list.filter(d => allowDocForUser(((d.title||'') + ' ' + (d.content||''))));
  }

  let fuse, docs=[], docsReady=false, docsError=false;

  function fetchIndex(){
    return fetch('{{ "/search.json" | relative_url }}')
      .then(r=>{
        if(!r.ok) throw new Error('search.json fetch ' + r.status);
        return r.json();
      })
      .then(d=>{
        try{
          if(typeof DocFilter!=='undefined'){
            d = DocFilter.filterDocs(d);
          }
        }catch(e){
            console.warn('DocFilter error', e);
        }
        // Sort by date desc
        d = d.slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
        d = filterDocs(d);
        docs = d;
        if(typeof Fuse!=='undefined'){
          fuse = new Fuse(docs, {
            keys:['title','content'],
            includeScore:true,
            threshold:0.4,
            ignoreLocation:true,
            minMatchCharLength:2
          });
        }
        docsReady=true;
        if(q.value.trim()) updateSuggestions();
      })
      .catch(e=>{
        docsError=true;
        console.error('Failed to load search index', e);
        showSuggestionMessage('インデックスを読み込めませんでした');
      })
      .finally(()=> renderChatFromParams());
  }
  fetchIndex();

  const norm = s => (s||'').toLowerCase();

  function searchDocs(query){
    if(!query) return [];
    query = query.trim();
    if(!docsReady || docsError) return [];
    if(fuse){
      return fuse.search(query).slice(0,5).map(r=>r.item);
    }
    const ql = norm(query);
    return docs.filter(d=>
      (d.title && norm(d.title).includes(ql)) ||
      (d.content && norm(d.content).includes(ql))
    ).slice(0,5);
  }

  function escapeHtml(s){
    return (s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function showSuggestionMessage(msg){
    suggestionsContainer.innerHTML =
      `<div class="suggestion-item" style="cursor:default;color:#555">${escapeHtml(msg)}</div>`;
    suggestionsContainer.style.display='block';
  }

  function updateSuggestions(){
    const text = q.value.trim();
    if(!text){
      suggestionsContainer.style.display='none';
      return;
    }
    if(docsError){
      showSuggestionMessage('インデックス読み込み失敗');
      return;
    }
    if(!docsReady){
      showSuggestionMessage('読み込み中...');
      return;
    }
    const r = searchDocs(text);
    if(!r.length){
      showSuggestionMessage('結果なし');
      return;
    }
    suggestionsContainer.innerHTML = r.map(d=>
      `<div class="suggestion-item" data-title="${escapeHtml(d.title||'')}">${escapeHtml(d.title||'(タイトルなし)')}</div>`
    ).join('');
    suggestionsContainer.style.display='block';
  }

  function getChatQueriesFromParams(){
    const p=new URLSearchParams(window.location.search);
    const list=[];
    if(p.has('Chat')) list.push(p.get('Chat').trim());
    let i=1;
    while(p.has('Chat'+i)){\n      list.push(p.get('Chat'+i).trim());\n      i++;\n    }\n    return list.filter(Boolean);
  }

  function addChatQueryToURL(newQuery){
    if(!newQuery) return;
    const params = new URLSearchParams(window.location.search);
    const currentTop = params.get('Chat');
    if(currentTop && currentTop === newQuery) return;
    let i=1;
    while(true){
      const key = i===1 ? 'Chat' : 'Chat'+(i-1);
      if(!params.has(key)) break;
      i++;
    }
    for(let k=i-1;k>=1;k--){
      const fromKey = k===1 ? 'Chat' : 'Chat'+(k-1);
      const toKey = 'Chat'+k;
      if(params.has(fromKey)){
        params.set(toKey, params.get(fromKey));
      }
    }
    params.set('Chat', newQuery);
    const newUrl = window.location.pathname + '?' + params.toString();
    history.pushState({},'',newUrl);
    renderChatFromParams();
  }

  function withEmbed(url){
    if(!url) return '#';
    if(url.includes('?')){
      if(/(?:^|[?&])embed(?:=|&|$)/.test(url)) return url;
      return url + '&embed';
    }
    return url + '?embed';
  }

  function renderChatFromParams(){
    const queries = getChatQueriesFromParams();
    if(!mainEl) return;
    if(!queries.length){
      mainEl.classList.add('no-chat');
      mainEl.classList.remove('chat-active');
      chatContainer.innerHTML='';
      return;
    }
    mainEl.classList.remove('no-chat');
    mainEl.classList.add('chat-active');
    chatContainer.innerHTML='';
    for(let i=queries.length-1;i>=0;i--){
      const isLatest = (i===0);
      renderPair(queries[i], isLatest);
    }
    loadPreviews();
    requestAnimationFrame(()=>{ chatContainer.scrollTop = chatContainer.scrollHeight; });
  }

  function renderPair(qry,isLatest){
    const r = searchDocs(qry);
    if(r.length){
      const it=r[0];
      const rawUrl = it.url || it.href || it.id || '#';
      const url = withEmbed(rawUrl);
      const userMsg=
        `<div class="chat-message user">
           <div class="message-bubble user" title="クリックして一番上に再追加">${escapeHtml(qry)}</div>
         </div>`;
      let botInner = '';
      if(isLatest){
        botInner = `<div class="doc-preview loading" data-url="${escapeHtml(url)}"></div>`;
      } else {
        botInner = `<strong title="タイトルをクリックすると再検索">${escapeHtml(it.title||'(タイトルなし)')}</strong>`;
        if(it.date){
          botInner += `<br><small>${escapeHtml((it.date||'').slice(0,10))}</small>`;
        }
      }
      const botMsg=
        `<div class="chat-message bot${isLatest?' latest':''}">
           <div class="message-bubble bot${isLatest?' latest-preview':''}">${botInner}</div>
         </div>`;
      chatContainer.insertAdjacentHTML('beforeend', userMsg + botMsg);
    } else {
      const userMsg=
        `<div class="chat-message user">
           <div class="message-bubble user" title="クリックして一番上に再追加">${escapeHtml(qry)}</div>
         </div>`;
      const botMsg=
        `<div class="chat-message bot">
           <div class="message-bubble bot">関連ドキュメントが見つかりませんでした</div>
         </div>`;
      chatContainer.insertAdjacentHTML('beforeend', userMsg + botMsg);
    }
  }

  function handleChatSubmit(){
    const val = q.value.trim();
    if(!val) return;
    const existing = getChatQueriesFromParams();
    if(existing.length && existing[0] === val){
      q.value='';
      return;
    }
    addChatQueryToURL(val);
    q.value='';
    suggestionsContainer.style.display='none';
  }

  let suggestTimer;
  q.addEventListener('input',()=>{
    clearTimeout(suggestTimer);
    if(!q.value.trim()){
      suggestionsContainer.style.display='none';
      return;
    }
    suggestTimer = setTimeout(()=>updateSuggestions(),140);
  });

  document.addEventListener('click',e=>{
    if(!suggestionsContainer.contains(e.target) && e.target!==q){
      suggestionsContainer.style.display='none';
    }
  });

  suggestionsContainer.addEventListener('click',e=>{
    const item = e.target.closest('.suggestion-item');
    if(!item) return;
    const t = item.dataset.title;
    if(!t) return;
    q.value = t;
    suggestionsContainer.style.display='none';
  });

  let enterLock=false;
  q.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      if(enterLock) return;
      enterLock=true;
      e.preventDefault();
      handleChatSubmit();
      setTimeout(()=>enterLock=false,250);
    }
    if((e.metaKey||e.ctrlKey) && e.key==='Enter'){
      e.preventDefault();
      handleChatSubmit();
    }
  });

  window.addEventListener('popstate',()=>{ renderChatFromParams(); });

  chatContainer.addEventListener('click', e=>{
    const userBubble = e.target.closest('.message-bubble.user');
    if(userBubble){
      const text = userBubble.textContent.trim();
      if(text) addChatQueryToURL(text);
      return;
    }
    const titleEl = e.target.closest('.chat-message.bot strong');
    if(titleEl){
      const text = titleEl.textContent.trim();
      if(text) addChatQueryToURL(text);
    }
  });

  function loadPreviews(){
    document.querySelectorAll('.doc-preview.loading[data-url]').forEach(preview=>{
      const url = preview.dataset.url;
      preview.classList.remove('loading');
      preview.innerHTML='';
      const iframe = document.createElement('iframe');
      iframe.loading='lazy';
      iframe.referrerPolicy='same-origin';
      iframe.src = url;
      iframe.style.opacity='0';
      preview.appendChild(iframe);

      const MIN = 400;
      iframe.addEventListener('load', ()=>{
        try{
          const doc = iframe.contentDocument;
          const h = Math.max(
            doc.documentElement.scrollHeight,
            doc.body.scrollHeight,
            doc.documentElement.offsetHeight,
            doc.body.offsetHeight,
            doc.documentElement.clientHeight
          );
          iframe.style.height = Math.min(h, 2000) + 'px';
        }catch(e){
          iframe.style.height = MIN + 'px';
        }
        iframe.style.transition='opacity .25s';
        requestAnimationFrame(()=>iframe.style.opacity='1');
      });

      setTimeout(()=>{
        if(iframe.style.opacity==='0'){
          iframe.style.opacity='1';
          if(!iframe.style.height) iframe.style.height = MIN + 'px';
        }
      },4000);
    });
  }
</script>
</body>
</html>